name: CI

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]
        tags: ["v*"]

jobs:
    test:
        name: Test (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, windows-latest, ubuntu-latest]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
            - name: Build
              run: cargo build --verbose
            - name: Test
              run: cargo test --verbose

    release-build:
        name: Release build (${{ matrix.os }})
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, windows-latest, ubuntu-latest]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
            - name: Build release
              run: cargo build --release --verbose
            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: skyset-${{ matrix.os }}
                  path: |
                      target/release/skyset*
