name: CI

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]
        tags: ["v*"]

jobs:
    test:
        name: Test (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, windows-latest, ubuntu-latest]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
            - name: Build
              run: cargo build --verbose
            - name: Test
              run: cargo test --verbose

    release-build:
        name: Release build (${{ matrix.os }})
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, windows-latest, ubuntu-latest]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Check tag is on main
              id: check_main
              run: |
                  git fetch origin main
                  if git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
                      echo "on_main=true" >> "$GITHUB_OUTPUT"
                  else
                      echo "on_main=false" >> "$GITHUB_OUTPUT"
                  fi
            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
              if: steps.check_main.outputs.on_main == 'true'
            - name: Build release
              run: cargo build --release --verbose
              if: steps.check_main.outputs.on_main == 'true'
            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              if: steps.check_main.outputs.on_main == 'true'
              with:
                  name: skyset-${{ matrix.os }}
                  path: |
                      target/release/skyset*
